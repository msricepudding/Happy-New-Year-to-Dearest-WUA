<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 跨年记忆</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; color: #e5b39b; -webkit-touch-callout: none; -webkit-user-select: none; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #start-btn { display: none; padding: 15px 45px; background: #b76e79; color: white; border: none; border-radius: 30px; font-size: 18px; box-shadow: 0 0 20px rgba(183,110,121,0.6); }
        #info { position: absolute; top: 30px; width: 100%; text-align: center; pointer-events: none; z-index: 50; }
        #webcam-video { display: none; }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="loading">
        <div id="status-text" style="margin-bottom:20px;">正在载入浪漫...</div>
        <button id="start-btn">开启跨年惊喜</button>
    </div>
    <div id="info">
        <h2 style="letter-spacing: 5px; font-weight: 300; margin: 0;">2026 ECHOES OF LOVE</h2>
        <p id="hint" style="font-size: 14px; opacity: 0.8; margin-top: 10px;">长按屏幕 爆炸</p>
    </div>
    <video id="webcam-video" autoplay playsinline></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://fastly.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://fastly.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://fastly.jsdelivr.net/npm/@mediapipe/hands/hands.js" async></script>
    <script src="https://fastly.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" async></script>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        let scene, camera, renderer, composer, heartGroup, photos = [];
        let isExploded = false;
        const PHOTO_COUNT = 21;

        // --- 核心场景搭建 ---
        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 40;
            
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(bloom);

            heartGroup = new THREE.Group();
            scene.add(heartGroup);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        }

        // --- 照片加载逻辑（兼容性增强） ---
        function createPhotoHeart() {
            const loader = new THREE.TextureLoader();
            for (let i = 0; i < PHOTO_COUNT; i++) {
                const t = (i / PHOTO_COUNT) * Math.PI * 2;
                const pos = new THREE.Vector3(
                    16 * Math.pow(Math.sin(t), 3) * 0.45,
                    (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.45,
                    (Math.random()-0.5) * 5
                );
                
                // 路径请务必确保正确
                loader.load(`./photos/photo_${i}.jpg`, (tex) => {
                    const group = new THREE.Group();
                    const photo = new THREE.Mesh(new THREE.PlaneGeometry(4, 5.5), new THREE.MeshStandardMaterial({ map: tex, side: THREE.DoubleSide }));
                    const frame = new THREE.Mesh(new THREE.BoxGeometry(4.2, 5.7, 0.1), new THREE.MeshStandardMaterial({ color: 0xB76E79, metalness: 0.8, roughness: 0.2 }));
                    group.add(photo, frame);
                    group.position.copy(pos);
                    group.lookAt(0, 0, 10);
                    
                    const data = {
                        mesh: group,
                        homePos: pos.clone(),
                        homeRot: group.quaternion.clone(),
                        targetPos: new THREE.Vector3((Math.random()-0.5)*80, (Math.random()-0.5)*80, (Math.random()-0.5)*40),
                        targetRot: new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.random()*5, Math.random()*5, Math.random()*5))
                    };
                    photos.push(data);
                    heartGroup.add(group);
                }, undefined, (err) => console.log("图片加载失败:", i));
            }
        }

        // --- 事件绑定逻辑（多端保底） ---
        function bindInteractions() {
            const setExplosion = (val) => { isExploded = val; };
            
            // 现代手机 Pointer 事件
            window.addEventListener('pointerdown', (e) => { e.preventDefault(); setExplosion(true); });
            window.addEventListener('pointerup', (e) => { e.preventDefault(); setExplosion(false); });
            
            // 兼容旧款 Touch
            window.addEventListener('touchstart', (e) => { e.preventDefault(); setExplosion(true); }, {passive: false});
            window.addEventListener('touchend', (e) => { e.preventDefault(); setExplosion(false); }, {passive: false});

            // 电脑点击
            window.addEventListener('mousedown', () => setExplosion(true));
            window.addEventListener('mouseup', () => setExplosion(false));
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.002;
            
            photos.forEach(p => {
                p.mesh.position.lerp(isExploded ? p.targetPos : p.homePos, 0.1);
                p.mesh.quaternion.slerp(isExploded ? p.targetRot : p.homeRot, 0.1);
                if(!isExploded) {
                    const s = 1 + Math.sin(time + p.homePos.x) * 0.03;
                    p.mesh.scale.set(s, s, s);
                }
            });
            
            heartGroup.rotation.y += 0.005;
            composer.render();
        }

        // --- 初始化执行 ---
        setupScene();
        createPhotoHeart();
        bindInteractions();

        // 无论如何，2秒后开启进入按钮
        setTimeout(() => {
            document.getElementById('status-text').style.display = 'none';
            const btn = document.getElementById('start-btn');
            btn.style.display = 'block';
            btn.onclick = () => {
                document.getElementById('loading').style.display = 'none';
                animate();
                // 尝试启动摄像头（即便失败也没关系，点击依然有效）
                if (window.Hands) setupAI(); 
            };
        }, 2000);

        async function setupAI() {
            try {
                const video = document.getElementById('webcam-video');
                const hands = new Hands({ locateFile: (f) => `https://fastly.jsdelivr.net/npm/@mediapipe/hands/${f}` });
                hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6 });
                hands.onResults(res => {
                    if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                        const lm = res.multiHandLandmarks[0];
                        isExploded = Math.hypot(lm[8].x
