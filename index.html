<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 跨年记忆</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; color: #e5b39b; }
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #status-text { font-size: 14px; letter-spacing: 1px; margin-bottom: 20px; color: #b76e79; }
        #start-btn { display: none; padding: 12px 40px; background: #b76e79; color: white; border: none; border-radius: 25px; font-size: 16px; box-shadow: 0 0 15px rgba(183,110,121,0.5); }
        #info { position: absolute; top: 40px; width: 100%; text-align: center; pointer-events: none; }
        video { position: absolute; bottom: 10px; left: 10px; width: 80px; opacity: 0; pointer-events: none; }
    </style>
</head>
<body>
    <div id="loading">
        <div id="status-text">正在准备浪漫记忆...</div>
        <button id="start-btn">开启跨年惊喜</button>
    </div>
    <div id="info">
        <h2 style="letter-spacing: 4px; font-weight: 300;">2026 ECHOES OF LOVE</h2>
        <p id="hint" style="font-size: 12px; opacity: 0.8;">加载中...</p>
    </div>
    <video id="webcam-video" autoplay playsinline></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://fastly.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://fastly.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://fastly.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';

        let scene, camera, renderer, composer, heartGroup, photos = [];
        let isExploded = false;
        const PHOTO_COUNT = 21;

        async function init() {
            // 1. 立即初始化 3D 引擎，不等待
            setupScene();
            
            // 2. 尝试并行加载资源
            const photoPromise = createPhotoHeart();
            const aiPromise = setupAI();

            // 只要 3D 准备好且照片开始加载，就允许进入
            setTimeout(() => {
                document.getElementById('status-text').style.display = 'none';
                document.getElementById('start-btn').style.display = 'block';
            }, 1500);

            document.getElementById('start-btn').onclick = () => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('hint').innerText = "长按屏幕 或 使用手势";
                // 手机端强制绑定触摸事件
                window.addEventListener('touchstart', () => isExploded = true);
                window.addEventListener('touchend', () => isExploded = false);
                window.addEventListener('mousedown', () => isExploded = true);
                window.addEventListener('mouseup', () => isExploded = false);
                animate();
            };
        }

        function setupScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.z = 40;
            renderer = new THREE.WebGLRenderer({ antialias: false }); // 手机关闭抗锯齿提升性能
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85);
            composer = new EffectComposer(renderer);
            composer.addPass(new RenderPass(scene, camera));
            composer.addPass(bloom);
            heartGroup = new THREE.Group();
            scene.add(heartGroup);
            scene.add(new THREE.AmbientLight(0xffffff, 1));
        }

        async function createPhotoHeart() {
            const loader = new THREE.TextureLoader();
            for (let i = 0; i < PHOTO_COUNT; i++) {
                const t = (i / PHOTO_COUNT) * Math.PI * 2;
                const pos = new THREE.Vector3(
                    16 * Math.pow(Math.sin(t), 3) * 0.4,
                    (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) * 0.4,
                    (Math.random()-0.5)*5
                );
                
                // 异步加载，不使用 await 阻塞
                loader.load(`./photos/photo_${i}.jpg`, (tex) => {
                    const group = new THREE.Group();
                    const photo = new THREE.Mesh(new THREE.PlaneGeometry(4, 5.5), new THREE.MeshStandardMaterial({ map: tex }));
                    const frame = new THREE.Mesh(new THREE.BoxGeometry(4.2, 5.7, 0.1), new THREE.MeshStandardMaterial({ color: 0xB76E79 }));
                    group.add(photo, frame);
                    group.position.copy(pos);
                    group.lookAt(0, 0, 10);
                    photos.push({
                        mesh: group, homePos: pos.clone(), homeRot: group.quaternion.clone(),
                        targetPos: new THREE.Vector3((Math.random()-0.5)*70, (Math.random()-0.5)*70, (Math.random()-0.5)*40),
                        targetRot: new THREE.Quaternion().setFromEuler(new THREE.Euler(Math.random()*5, Math.random()*5, Math.random()*5))
                    });
                    heartGroup.add(group);
                });
            }
        }

        async function setupAI() {
            try {
                const hands = new Hands({ locateFile: (f) => `https://fastly.jsdelivr.net/npm/@mediapipe/hands/${f}` });
                hands.setOptions({ maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.6 });
                hands.onResults(res => {
                    if (res.multiHandLandmarks && res.multiHandLandmarks[0]) {
                        const lm = res.multiHandLandmarks[0];
                        isExploded = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y) > 0.12;
                    }
                });
                const video = document.getElementById('webcam-video');
                const cam = new Camera(video, { onFrame: async () => await hands.send({image: video}), width: 480, height: 360 });
                await cam.start();
            } catch (e) { console.log("AI 模式启动失败，切换纯点击模式"); }
        }

        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now() * 0.002;
            photos.forEach(p => {
                p.mesh.position.lerp(isExploded ? p.targetPos : p.homePos, 0.1);
                p.mesh.quaternion.slerp(isExploded ? p.targetRot : p.homeRot, 0.1);
                if(!isExploded) {
                    const s = 1 + Math.sin(time + p.homePos.x) * 0.03;
                    p.mesh.scale.set(s, s, s);
                }
            });
            heartGroup.rotation.y += 0.005;
            composer.render();
        }
        init();
    </script>
</body>
</html>
